## TCP (Transmission Control Protocol)
인터넷상에서 데이터를 메세지의 형태로 보내기 위해 IP와 사용하는 프로토콜   

TCP는 애플리케이션에게 **신뢰적이고 연결지향성** 서비스를 제공한다.   
일반적으로 TCP와 IP는 함께 사용되며 **IP는 배달을, TCP는 패킷의 추적 및 관리를 한다.**

TCP는 연결형 서비스로, 신뢰적인 전송을 보장하기에 handshake하고 데이터의 흐름제어와 혼잡제어를 수행한다. -> **이로 인해 TCP 속도는 UDP보다 느리다.**

* TCP 특징
    - 3-Way HandShaking 과정을 통해 연결을 설정하고 4-Way HandShake을 통해 연결 해제를 한다.
    - 흐름 제어 및 혼잡 제어.
    - 높은 신뢰성
    - UDP 보다 속도가 느리다.
    - 전이중, 점대점 방식.
    - 가상회선 패킷 교환 방식을 사용한다.

### 가상 회선 패킷 교환 방식

* 각 패킷에는 가상회선 식별자가 포함되며 모든 패킷을 전송하면 가상회선이 해제되고 패킷들은 전송된  **순서대로 도착하는** 방식
![Alt text](../image/image-1.png)

## 1. 3-Way HandShake (TCP 연결)

TCP는 장치들 사이에 논리적인 접속을 성립하기 위해 3 Way HandShake를 사용한다.   
이러한 절차는 TCP 접속을 성공적으로 성립하기 위해 반드시 필요하다.

![Alt text](../image/image.png)

1. `SYN 단계` : 클라이언트는 서버에 클라이언트의 `ISN`을 담아 `SYN`을 보낸다.
    - **ISN** : 새로운 TCP 연결의 첫 번째 패킷에 할당된 임의의 시퀀스 번호를 말한다. (위 그림에서는 100)
2. `SYN + ACK 단계` : 서버는 클라이언트의 `SYN`을 수신하고 서버의 `ISN(200)` 과 `ACK`(승인번호) 로 클라이언트의 `ISN + 1` 을 보낸다.
3. `ACK 단계` : 클라이언트는 서버의 `ISN + 1` 한 값인 승인번호를 받아서 `ACK`를 서버에 보낸다.
   
- 위 과정 이후 신뢰성이 구축되고 데이터 전송을 시작한다.
- UDP는 이 과정이 없기 때문에 신뢰성이 없는 계층이라고 말한다.

> `SYN` - SYNchronization의 약자로 연결 요청 플래그이다.   
`ACK` - ACKnowledgement의 약자, 응답 플래그이다.   
`ISN` - Initial Sequence Numbers의 약어로서 초기 네트워크를 연결할 때 할당된 32비트 고유 시퀀스 번호이다.
>

## 4-Way HandShake (TCP 연결 해제)
![Alt text](../image/image-3.png)

1. 먼저 클라이언트가 연결을 닫으려고 할 때 `FIN`으로 설정된 세그먼트를 보낸다. 그리고 클라이언트는 `FIN_WAIT_1` 상태로 들어가고 서버의 응답을 기다린다.
2.  서버는 클라이언트로 `ACK`라는 승인 세그먼트를 보낸다. 그리고 `CLOSE_WAIT` 상태에 들어간다. 클라이언트는 세그먼트를 받으면 `FIN_WAIT_2` 상태에 들어간다.
3. 서버는 `ACK`를 보내고 일정 시간 이후에 클라이언트에 `FIN`이라는 세그먼트를 보낸다.
4. 클라이언트는 `TIME_WAIT` 상태가 되고 다시 서버로 `ACK`를 보내서 서버는 `CLOSED`상태가 된다. 이후 클라이언트는 어느 정도의 시간을 대기한 후 연결이 닫히고 클라이언트와 서버의 모든 자원의 연결이 해제된다.

> **그냥 연결을 닫으면 되는데 왜 굳이 일정 시간 뒤에 닫을까?**

1. **지연 패킷이 발생할 경우를 대비하기 위함** → 패킷이 뒤늦게 도달하고 이를 처리하지 못한다면 데이터 무결성 문제가 발생한다.

2. **두 장치가 연결이 닫혔는지 재확인하기 위해서** → `LAST_ACK`상태에서 닫히게 되면 다시 새로운 연결을 하려고 할 때 장치는 줄곧 `LAST_ACK`로 되어 있기때문에 접속 오류가 나타나게 된다.
>